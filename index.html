<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFD Size-Up Builder</title>

  <!-- iPhone / PWA settings -->
  <meta name="theme-color" content="#0b1a3a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    /* Color palette inspired by your patch */
    :root{
      --navy:#0b1a3a;
      --navy2:#111f42;
      --gold:#caa24a;
      --blue:#2563eb;     /* selection blue */
      --red:#c1121f;

      --text:#0b1220;
      --muted: rgba(11,18,32,.75);

      --cardBorder: rgba(255,255,255,.20);

      /* Section fills */
      --secBuilding:#fde68a; /* warm yellow */
      --secProblem:#fecaca;  /* light red */
      --secIAP:#bbf7d0;      /* light green */
      --secCommand:#bfdbfe;  /* light blue */

      /* Watermark controls */
      --wmOpacity: 0.10;     /* increase to 0.14 if you want more visible */
      --wmSize: 820px;       /* watermark size */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #172554 0%, var(--navy) 55%) fixed;
      color: #e9eefc;
    }

    /* Watermark layer */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: var(--wmSize);
      opacity: var(--wmOpacity);
      pointer-events: none;
      z-index: 0;
      filter: saturate(1.05);
    }

    header{
      padding:14px 16px;
      background: rgba(17,31,66,.90);
      position: sticky;
      top:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      z-index: 2;
    }
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .hint{color:rgba(233,238,252,.75);font-size:12px;margin-top:4px}

    .wrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
      position: relative;
      z-index: 1; /* above watermark */
    }

    .card{
      background: rgba(18,26,43,.75);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }

    /* Section blocks (different colors) */
    .section{
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
      border: 1px solid rgba(0,0,0,.10);
      color: var(--text);
    }
    .section h2{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .section.building{ background: var(--secBuilding); }
    .section.problem{  background: var(--secProblem); }
    .section.iap{      background: var(--secIAP); }
    .section.command{  background: var(--secCommand); }

    .group-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 10px 0;
    }
    .group-title b{font-size:14px;color:var(--text)}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}

    /* 4 across buttons */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }

    /* White buttons */
    button.choice{
      border:1px solid rgba(0,0,0,.10);
      background:#ffffff;
      color: var(--text);
      padding:12px 10px;
      border-radius:12px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    button.choice:active{transform: scale(.99);}

    /* Selected = blue */
    button.choice.selected{
      border-color: var(--blue);
      background: var(--blue);
      color:#ffffff;
      box-shadow: 0 10px 22px rgba(37,99,235,.22);
    }

    /* Responsive for phones */
    @media (max-width: 900px){
      .grid{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    }
    @media (max-width: 600px){
      .grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color: var(--text);
      font-size:15px;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
    }

    /* Output card styling */
    .outputTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 10px 0;
    }
    .outputTitle b{font-size:14px;color:#e9eefc}

    .output{
      white-space:pre-wrap;
      font-size:16px;
      line-height:1.35;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      min-height:170px;
      color:#e9eefc;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#e9eefc;
      padding:12px 12px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(202,162,74,.55);
      background: rgba(202,162,74,.18);
    }
    .btn.danger{
      border-color: rgba(193,18,31,.55);
      background: rgba(193,18,31,.18);
    }
  </style>
</head>

<body>
<header>
  <h1>MFD Size-Up Builder</h1>
  <div class="hint">Tap selections → paragraph updates → Copy.</div>
</header>

<div class="wrap">
  <div class="card" id="controls"></div>

  <div class="card">
    <div class="outputTitle"><b>Generated Size-Up</b></div>
    <div class="output" id="outputBox">Make selections to build your size-up.</div>
    <div class="row">
      <button class="btn primary" id="copyBtn">Copy</button>
      <button class="btn danger" id="clearBtn">Clear</button>
    </div>
  </div>
</div>

<script>
  // Offline cache
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("service-worker.js"));
  }

  // ---------- Button Groups ----------
  // mode: "single" or "multi"
  const CONFIG = [
    { key:"buildingSize", title:"Building Size", mode:"single", options:[
      { value:"small",  label:"Small",  phrase:"a small" },
      { value:"medium", label:"Medium", phrase:"a medium" },
      { value:"large",  label:"Large",  phrase:"a large" },
      { value:"mega",   label:"Mega",   phrase:"a mega" }
    ]},

    { key:"height", title:"Height (Floors)", mode:"single", options:[
      { value:"1", label:"1", phrase:"one-story" },
      { value:"2", label:"2", phrase:"two-story" },
      { value:"3", label:"3", phrase:"three-story" },
      { value:"4", label:"4", phrase:"four-story" },
      { value:"5", label:"5", phrase:"five-story" }
    ]},

    { key:"occupancy", title:"Occupancy Type", mode:"single", options:[
      { value:"house", label:"House", phrase:"house" },
      { value:"apartment", label:"Apartment", phrase:"apartment" },
      { value:"strip", label:"Strip Center", phrase:"strip center" },
      { value:"commercial", label:"Commercial", phrase:"commercial" },
      { value:"other", label:"Other", phrase:"" }
    ]},

    { key:"conditions", title:"Condition", mode:"single", options:[
      { value:"nothing", label:"Nothing Showing", phrase:"Nothing showing at this time." },
      { value:"light", label:"Light Smoke", phrase:"Light smoke showing." },
      { value:"heavy", label:"Heavy Smoke", phrase:"Heavy smoke showing." },
      { value:"working", label:"Working Fire", phrase:"Working fire conditions present." },
      { value:"defensive", label:"Defensive Conditions", phrase:"Defensive fire conditions present." }
    ]},

    { key:"problemSides", title:"Location of the Problem (multi)", mode:"multi", options:[
      { value:"Alpha", label:"Alpha", phrase:"Alpha" },
      { value:"Bravo", label:"Bravo", phrase:"Bravo" },
      { value:"Charlie", label:"Charlie", phrase:"Charlie" },
      { value:"Delta", label:"Delta", phrase:"Delta" }
    ]},

    { key:"iapTasks", title:"Task (multi)", mode:"multi", options:[
      { value:"Investigate", label:"Investigate", phrase:"Investigate" },
      { value:"Water Supply", label:"Water Supply", phrase:"Establish water supply" },
      { value:"Attack Line", label:"Attack Line", phrase:"Deploy attack line" },
      { value:"Rescue", label:"Rescue", phrase:"Initiate rescue" },
      { value:"OEO", label:"OEO", phrase:"Establish OEO" },
      { value:"Defensive Op", label:"Defensive Op", phrase:"Set up defensive operations" }
    ]},

    { key:"iapLocation", title:"IAP Location", mode:"single", options:[
      { value:"Alpha", label:"Alpha", phrase:"Alpha" },
      { value:"Bravo", label:"Bravo", phrase:"Bravo" },
      { value:"Charlie", label:"Charlie", phrase:"Charlie" },
      { value:"Delta", label:"Delta", phrase:"Delta" }
    ]},

    { key:"iapObjectives", title:"Objective (multi)", mode:"multi", options:[
      { value:"Fire Attack", label:"Fire Attack", phrase:"Fire attack" },
      { value:"Primary Search", label:"Primary Search", phrase:"Primary search" }
    ]},

    { key:"strategy", title:"Strategy", mode:"single", options:[
      { value:"Offensive", label:"Offensive", phrase:"Offensive" },
      { value:"Defensive", label:"Defensive", phrase:"Defensive" }
    ]}
  ];

  // ---------- Text Fields (general) ----------
  // NOTE: Occupancy Other is handled inline under the Occupancy section (not here).
  const TEXT_FIELDS = [
    { key:"problemLocationText", label:"Location of the Problem (free text)", placeholder:"e.g., 2nd floor Bravo / roof line / rear storage…" },
    { key:"assumeCommand", label:"Assume/Name Command (type it)", placeholder:"e.g., Engine 1 assuming Main Street Command" }
  ];

  // ---------- State ----------
  const state = {};
  const controlsEl = document.getElementById("controls");
  const outputBox = document.getElementById("outputBox");

  // ---------- Sections ----------
  const SECTIONS = [
    { cssClass:"building", title:"Building / Area Description", keys:["buildingSize","height","occupancy"] },
    { cssClass:"problem",  title:"Problem Description",         keys:["conditions","problemSides"] },
    { cssClass:"iap",      title:"Initial Action Plan",         keys:["iapTasks","iapLocation","iapObjectives"] },
    { cssClass:"command",  title:"Strategy / Command",          keys:["strategy"] }
  ];

  function init() {
    renderControls();
    document.getElementById("copyBtn").addEventListener("click", copyText);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    updateOutput();
  }

  function onChoice(group, value) {
    if (group.mode === "single") {
      state[group.key] = value;
    } else {
      const current = Array.isArray(state[group.key]) ? state[group.key] : [];
      state[group.key] = current.includes(value)
        ? current.filter(v => v !== value)
        : [...current, value];
    }

    // Re-render so conditional inputs (like Occupancy Other) appear immediately
    renderControls();
    updateOutput();
  }

  function renderControls() {
    controlsEl.innerHTML = "";

    function renderGroup(groupKey, parentEl) {
      const group = CONFIG.find(g => g.key === groupKey);
      if (!group) return;

      const wrap = document.createElement("div");
      wrap.style.marginBottom = "12px";

      const title = document.createElement("div");
      title.className = "group-title";
      title.innerHTML = `<b>${group.title}</b>`;
      wrap.appendChild(title);

      const grid = document.createElement("div");
      grid.className = "grid";

      group.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = opt.label;
        btn.dataset.key = group.key;
        btn.dataset.value = opt.value;
        btn.addEventListener("click", () => onChoice(group, opt.value));
        grid.appendChild(btn);
      });

      wrap.appendChild(grid);

      // Occupancy "Other" input directly under Occupancy Type
      if (group.key === "occupancy" && state.occupancy === "other") {
        const label = document.createElement("label");
        label.textContent = "Occupancy Type (Other) – type here";
        wrap.appendChild(label);

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "e.g., school, church, warehouse…";
        input.value = state.occupancyOther || "";
        input.addEventListener("input", (e) => {
          state.occupancyOther = e.target.value;
          updateOutput();
        });
        wrap.appendChild(input);
      }

      parentEl.appendChild(wrap);
    }

    // Render each colored section block
    SECTIONS.forEach(sec => {
      const secEl = document.createElement("div");
      secEl.className = `section ${sec.cssClass}`;

      const header = document.createElement("h2");
      header.textContent = sec.title;
      secEl.appendChild(header);

      sec.keys.forEach(k => renderGroup(k, secEl));
      controlsEl.appendChild(secEl);
    });

    // Render remaining text fields at bottom
    TEXT_FIELDS.forEach(tf => {
      const label = document.createElement("label");
      label.textContent = tf.label;
      controlsEl.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = tf.placeholder;
      input.value = state[tf.key] || "";
      input.addEventListener("input", (e) => {
        state[tf.key] = e.target.value;
        updateOutput();
      });
      controlsEl.appendChild(input);
    });

    refreshSelectedUI();
  }

  function refreshSelectedUI() {
    document.querySelectorAll("button.choice").forEach(btn => {
      const key = btn.dataset.key;
      const value = btn.dataset.value;
      const group = CONFIG.find(g => g.key === key);
      const current = state[key];

      let selected = false;
      if (group.mode === "single") selected = current === value;
      else selected = Array.isArray(current) && current.includes(value);

      btn.classList.toggle("selected", selected);
    });
  }

  function optionPhrase(groupKey, value) {
    const group = CONFIG.find(g => g.key === groupKey);
    if (!group) return "";
    return (group.options.find(o => o.value === value)?.phrase || "").trim();
  }

  function singlePhrase(key) {
    const val = state[key];
    if (!val) return "";
    return optionPhrase(key, val);
  }

  function multiList(key) {
    const arr = Array.isArray(state[key]) ? state[key] : [];
    return arr.filter(Boolean);
  }

  function updateOutput() {
    // Opening: size + height + occupancy (or occupancyOther)
    const size = singlePhrase("buildingSize");
    const height = singlePhrase("height");

    let occupancy = "";
    const occVal = state.occupancy;
    if (occVal === "other") {
      occupancy = (state.occupancyOther || "").trim();
    } else if (occVal) {
      occupancy = optionPhrase("occupancy", occVal);
    }

    const openingParts = [];
    if (size) openingParts.push(size);
    if (height) openingParts.push(height);
    if (occupancy) openingParts.push(occupancy);

    let text = openingParts.length
      ? `We have ${openingParts.join(", ")}.`
      : `We have a structure.`;

    // Conditions sentence
    const cond = singlePhrase("conditions");
    if (cond) text += `\n\n${cond}`;

    // Location of the problem: multi sides + free text
    const sides = multiList("problemSides");
    const sidesText = sides.length ? sides.join("/") : "";
    const locFree = (state.problemLocationText || "").trim();
    if (sidesText || locFree) {
      text += ` Location of the problem: ${[sidesText, locFree].filter(Boolean).join(" – ")}.`;
    }

    // IAP
    const tasks = multiList("iapTasks").map(v => optionPhrase("iapTasks", v)).filter(Boolean);
    const iapLoc = singlePhrase("iapLocation");
    const objectives = multiList("iapObjectives").map(v => optionPhrase("iapObjectives", v)).filter(Boolean);

    if (tasks.length || iapLoc || objectives.length) {
      text += `\n\nInitial Action Plan:`;
      if (tasks.length) text += ` Tasks: ${tasks.join(", ")}.`;
      if (iapLoc) text += ` Location: ${iapLoc}.`;
      if (objectives.length) text += ` Objectives: ${objectives.join(", ")}.`;
    }

    // Strategy
    const strat = singlePhrase("strategy");
    if (strat) text += `\n\nStrategy: ${strat}.`;

    // Assume/Name Command
    const cmd = (state.assumeCommand || "").trim();
    if (cmd) text += `\n\nAssume/Name Command: ${cmd}.`;

    outputBox.textContent = text;
  }

  async function copyText() {
    const text = outputBox.textContent || "";
    try {
      await navigator.clipboard.writeText(text);
      alert("Copied!");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Copied!");
    }
  }

  function clearAll() {
    Object.keys(state).forEach(k => delete state[k]);
    renderControls();
    updateOutput();
  }

  init();
</script>
</body>
</html>
