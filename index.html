<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFD Blue Card Trainer</title>

  <!-- iPhone / PWA settings -->
  <meta name="theme-color" content="#0b1a3a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --navy:#0b1a3a;
      --blue:#2563eb;
      --text:#0b1220;
      --muted: rgba(11,18,32,.75);

      --secOps:#fde68a;
      --secBuilding:#fecaca;
      --secProblem:#bbf7d0;
      --secIAP:#bfdbfe;
      --secCmd:#ddd6fe;
      --secFollow:#cffafe;

      --wmOpacity: 0.75;
      --wmSize: 820px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #172554 0%, var(--navy) 55%) fixed;
      color:#e9eefc;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: var(--wmSize);
      opacity: var(--wmOpacity);
      pointer-events: none;
      z-index: 0;
    }

    header{
      padding:14px 16px;
      background: rgba(17,31,66,.90);
      position: sticky;
      top:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      z-index: 2;
    }
    h1{margin:0;font-size:16px}
    .hint{color:rgba(233,238,252,.75);font-size:12px;margin-top:4px}

    .wrap{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      padding:12px;
      position:relative;
      z-index:1;
    }

    .card{
      background: rgba(18,26,43,.75);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }

    .block{
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.10);
      color:var(--text);
    }
    .block h2{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:var(--text);
    }

    .ops{background:var(--secOps)}
    .building{background:var(--secBuilding)}
    .problem{background:var(--secProblem)}
    .iap{background:var(--secIAP)}
    .cmd{background:var(--secCmd)}
    .follow{background:var(--secFollow)}

    .irrWrap{
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.10);
      color:var(--text);
    }
    .irrTitle{
      margin:0 0 10px 0;
      font-size:18px;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-weight:900;
      color:#ffffff;
    }

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .twoCol{grid-template-columns:1fr;}
    }

    .miniRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .miniRow{grid-template-columns:1fr;}
    }

    label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin:10px 0 6px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    /* Smaller quick-buttons grid */
    .grid.small{
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }
    @media (max-width: 600px){
      .grid.small{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    button.choice{
      border:1px solid rgba(0,0,0,.10);
      background:#ffffff;
      color:var(--text);
      padding:12px 10px;
      border-radius:12px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    button.choice.selected{
      border-color:var(--blue);
      background:var(--blue);
      color:#ffffff;
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }

    button.choice.small{
      padding:10px 10px;
      font-size:13px;
      font-weight:900;
      border-radius:10px;
    }

    .selectRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .selectRow{grid-template-columns:1fr;}
    }
    select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color:var(--text);
      font-size:15px;
      font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color:var(--text);
      font-size:15px;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    .outputTitle{margin:0 0 10px 0;}
    .outputTitle b{color:#e9eefc;font-size:14px}

    .output{
      white-space:pre-wrap;
      font-size:16px;
      line-height:1.35;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      min-height:170px;
      color:#e9eefc;
    }

    .boldLabel{
      font-weight:900;
      color:var(--text);
      font-size:12px;
      margin:10px 0 6px;
      display:block;
    }

    #followControlsCard{
      border: 3px solid #2563eb;
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }

    .twoBtnRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
  </style>
</head>

<body>
<header>
  <h1>MFD Size-Up Builder</h1>
  <div class="hint">Tap selections → paragraphs update → Copy.</div>
</header>

<div class="wrap">
  <div class="card" id="controls"></div>

  <div class="card">
    <div class="outputTitle"><b>Generated Size-Up</b></div>
    <div class="output" id="outputBox"></div>
  </div>

  <div class="card" id="followControlsCard"></div>

  <div class="card">
    <div class="outputTitle"><b>Generated Follow-Up Report</b></div>
    <div class="output" id="followOutputBox"></div>
  </div>
</div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("service-worker.js"));
  }

  // ---------- Groups (Size-up) ----------
  const CONFIG = [
    { key:"buildingSize", title:"Building Size", mode:"single", options:[
      { value:"Small",  label:"Small",  phrase:"Small" },
      { value:"Medium", label:"Medium", phrase:"Medium" },
      { value:"Large",  label:"Large",  phrase:"Large" },
      { value:"Mega",   label:"Mega",   phrase:"Mega" }
    ]},
    { key:"height", title:"Building Height", mode:"single", options:[
      { value:"1", label:"1", phrase:"1 story" },
      { value:"2", label:"2", phrase:"2 story" },
      { value:"3", label:"3", phrase:"3 story" },
      { value:"4", label:"4", phrase:"4 story" },
      { value:"5", label:"5", phrase:"5 story" }
    ]},
    { key:"occupancy", title:"Occupancy Type", mode:"single", options:[
      { value:"house", label:"House", phrase:"house" },
      { value:"apartment", label:"Apartment", phrase:"apartment" },
      { value:"strip", label:"Strip Center", phrase:"strip center" },
      { value:"commercial", label:"Commercial", phrase:"commercial" },
      { value:"other", label:"Other", phrase:"" }
    ]},

    { key:"conditions", title:"Condition", mode:"single", options:[
      { value:"nothing", label:"Nothing Showing", phrase:"nothing showing" },
      { value:"light", label:"Light Smoke", phrase:"light smoke" },
      { value:"heavy", label:"Heavy Smoke", phrase:"heavy smoke" },
      { value:"working", label:"Working Fire", phrase:"working fire" },
      { value:"defensive", label:"Defensive Conditions", phrase:"defensive conditions" }
    ]},
    { key:"problemSides", title:"Location of the Problem (multi)", mode:"multi", options:[
      { value:"Alpha", label:"Alpha", phrase:"alpha" },
      { value:"Bravo", label:"Bravo", phrase:"bravo" },
      { value:"Charlie", label:"Charlie", phrase:"charlie" },
      { value:"Delta", label:"Delta", phrase:"delta" }
    ]},

    { key:"iapTasks", title:"Task (multi)", mode:"multi", options:[
      { value:"Investigate", label:"Investigate", phrase:"investigating" },
      { value:"Water Supply", label:"Water Supply", phrase:"setting up water supply" },
      { value:"Attack Line", label:"Attack Line", phrase:"attack line" },
      { value:"Rescue", label:"Rescue", phrase:"rescue" },
      { value:"OEO", label:"OEO", phrase:"OEO" },
      { value:"Defensive Op", label:"Defensive Op", phrase:"defensive operations" }
    ]},
    { key:"iapLocation", title:"IAP Location (multi)", mode:"multi", options:[
      { value:"1st Floor", label:"1st Floor", phrase:"1st floor" },
      { value:"2nd Floor", label:"2nd Floor", phrase:"2nd floor" },
      { value:"3rd Floor", label:"3rd Floor", phrase:"3rd floor" },
      { value:"4th Floor", label:"4th Floor", phrase:"4th floor" },
      { value:"Alpha",     label:"Alpha",     phrase:"alpha" },
      { value:"Bravo",     label:"Bravo",     phrase:"bravo" },
      { value:"Charlie",   label:"Charlie",   phrase:"charlie" },
      { value:"Delta",     label:"Delta",     phrase:"delta" },
      { value:"other",     label:"Other",     phrase:"" }
    ]},
    { key:"iapObjectives", title:"Objective (multi)", mode:"multi", options:[
      { value:"Fire Attack", label:"Fire Attack", phrase:"fire attack" },
      { value:"Primary Search", label:"Primary Search", phrase:"primary search" }
    ]},

    { key:"resourceDetermination", title:"Resource Determination", mode:"single", options:[
      { value:"Recall units", label:"Recall units", phrase:"Recall units" },
      { value:"2nd alarm", label:"2nd alarm", phrase:"2nd alarm" }
    ]}
  ];

  // Problem location quick buttons (small)
  const PROBLEM_QUICK = [
    "1st Floor","2nd Floor","3rd Floor","Corner","Roof","Roof Line","Backyard","Garage","Other"
  ];

  const BATTALIONS = ["", "BC1", "BC2"];
  const APPARATUS = ["",
    "Trk 1","Eng 2","Trk 3","Eng 4","Trk 5","Eng 6","Eng 7","Trk 9","Eng 10","Trk 11",
    "Med 1","Med 2","Med 3","Med 5","Med 6","Med 7","Med 9","Med 10","Med 11"
  ];

  // ---------- State ----------
  const state = {};
  const fstate = {};

  const controlsEl = document.getElementById("controls");
  const outputBox = document.getElementById("outputBox");
  const followOutputBox = document.getElementById("followOutputBox");

  function onChoice(group, value){
    if (group.mode === "single") state[group.key] = value;
    else {
      const current = Array.isArray(state[group.key]) ? state[group.key] : [];
      state[group.key] = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
    }
    renderControls();
    updateOutputs();
  }

  function onFollowChoice(groupKey, mode, value){
    if (mode === "single"){
      fstate[groupKey] = value;
    } else {
      const current = Array.isArray(fstate[groupKey]) ? fstate[groupKey] : [];
      fstate[groupKey] = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
    }
    renderControls();
    updateOutputs();
  }

  function optionPhrase(groupKey, value){
    const group = CONFIG.find(g => g.key === groupKey);
    if (!group) return "";
    return (group.options.find(o => o.value === value)?.phrase || "").trim();
  }
  function singlePhrase(key){
    const val = state[key];
    if (!val) return "";
    return optionPhrase(key, val);
  }
  function multiList(key){
    const arr = Array.isArray(state[key]) ? state[key] : [];
    return arr.filter(Boolean);
  }

  function niceSidesDisplay(sidesArr){
    return sidesArr.map(s => s.toLowerCase()).join(" ");
  }

  function mapIapLocation(val){
    if (!val) return "";
    const lower = String(val).toLowerCase();
    if (["alpha","bravo","charlie","delta"].includes(lower)) return `${lower} side`;
    if (lower.includes("floor")) return lower;
    return lower;
  }

  function buildIapLocationPhrase(iapLocArr, otherText){
    const arr = Array.isArray(iapLocArr) ? iapLocArr : [];
    const parts = [];
    for (const v of arr){
      if (v === "other") continue;
      parts.push(mapIapLocation(v));
    }
    const other = (otherText || "").trim();
    if (arr.includes("other") && other) parts.push(other.toLowerCase());
    const uniq = [...new Set(parts)].filter(Boolean);
    return uniq.join(", ");
  }

  function normalizeCommandName(raw){
    let s = (raw || "").trim();
    if (!s) return "";
    if (/command\.?$/i.test(s)) return s.replace(/\.*$/,"");
    return `${s} Command`;
  }

  function battalionDisplay(code){
    const c = (code || "").trim();
    if (c === "BC1") return "Battalion 1";
    if (c === "BC2") return "Battalion 2";
    return "";
  }

  function renderButtonGroup(group, parentEl){
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "12px";

    const title = document.createElement("div");
    title.style.margin = "0 0 10px 0";
    title.innerHTML = `<b>${group.title}</b>`;
    parentEl.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = opt.label;
      btn.dataset.key = group.key;
      btn.dataset.value = opt.value;
      btn.addEventListener("click", () => onChoice(group, opt.value));
      grid.appendChild(btn);
    });

    wrap.appendChild(grid);

    // Occupancy Other
    if (group.key === "occupancy" && state.occupancy === "other") {
      const label = document.createElement("label");
      label.textContent = "Occupancy Type";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., school, church, warehouse…";
      input.value = state.occupancyOther || "";
      input.addEventListener("input", (e) => {
        state.occupancyOther = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    // Problem location (quick buttons + text)
    if (group.key === "problemSides") {
      const quickTitle = document.createElement("label");
      quickTitle.textContent = "Location of the Problem Area (quick)";
      wrap.appendChild(quickTitle);

      const qGrid = document.createElement("div");
      qGrid.className = "grid small";

      PROBLEM_QUICK.forEach(label => {
        const btn = document.createElement("button");
        btn.className = "choice small";
        btn.textContent = label;
        btn.addEventListener("click", () => {
          const current = Array.isArray(state.problemLocQuick) ? state.problemLocQuick : [];
          state.problemLocQuick = current.includes(label)
            ? current.filter(v => v !== label)
            : [...current, label];
          renderControls();
          updateOutputs();
        });
        qGrid.appendChild(btn);
      });

      wrap.appendChild(qGrid);

      const label = document.createElement("label");
      label.textContent = "Location of the Problem (Free Text)";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., rear storage, stairwell, room off hallway…";
      input.value = state.problemLocationText || "";
      input.addEventListener("input", (e) => {
        state.problemLocationText = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    // IAP Location Other
    if (group.key === "iapLocation" && Array.isArray(state.iapLocation) && state.iapLocation.includes("other")) {
      const label = document.createElement("label");
      label.textContent = "IAP Location (Other)";
      wrap.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., interior stairwell, basement, roof division…";
      input.value = state.iapLocationOther || "";
      input.addEventListener("input", (e) => {
        state.iapLocationOther = e.target.value;
        updateOutputs();
      });
      wrap.appendChild(input);
    }

    parentEl.appendChild(wrap);
  }

  function renderDropdownBlock(parentEl){
    const block = document.createElement("div");
    block.className = "block ops";
    block.innerHTML = `<h2>Batt / Apparatus</h2>`;

    const row = document.createElement("div");
    row.className = "selectRow";

    const battWrap = document.createElement("div");
    const battLabel = document.createElement("label");
    battLabel.textContent = "Battalion";
    battWrap.appendChild(battLabel);

    const battSel = document.createElement("select");
    BATTALIONS.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v || "Select Battalion…";
      battSel.appendChild(opt);
    });
    battSel.value = state.battalion || "";
    battSel.addEventListener("change", (e) => {
      state.battalion = e.target.value;
      updateOutputs();
    });
    battWrap.appendChild(battSel);

    const appWrap = document.createElement("div");
    const appLabel = document.createElement("label");
    appLabel.textContent = "Apparatus";
    appWrap.appendChild(appLabel);

    const appSel = document.createElement("select");
    APPARATUS.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v || "Select Apparatus…";
      appSel.appendChild(opt);
    });
    appSel.value = state.apparatus || "";
    appSel.addEventListener("change", (e) => {
      state.apparatus = e.target.value;
      updateOutputs();
    });
    appWrap.appendChild(appSel);

    row.appendChild(battWrap);
    row.appendChild(appWrap);

    block.appendChild(row);
    parentEl.appendChild(block);
  }

  // ------- Follow-up rendering helpers -------
  function renderTwoButtonSingle(parentEl, titleText, key, leftLabel, rightLabel){
    const title = document.createElement("div");
    title.style.margin = "12px 0 10px 0";
    title.innerHTML = `<b>${titleText}</b>`;
    parentEl.appendChild(title);

    const row = document.createElement("div");
    row.className = "twoBtnRow";

    [leftLabel, rightLabel].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = key;
      btn.dataset.fvalue = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        fstate[key] = v;
        refreshSelectedUI();
        renderControls();
        updateOutputs();
      });
      row.appendChild(btn);
    });

    parentEl.appendChild(row);
  }

  function renderFollowMultiGroup(parentEl, titleText, key, options, otherKey){
    const title = document.createElement("div");
    title.style.margin = "12px 0 10px 0";
    title.innerHTML = `<b>${titleText}</b>`;
    parentEl.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = key;
      btn.dataset.fvalue = opt.value;
      btn.textContent = opt.label;

      btn.addEventListener("click", () => onFollowChoice(key, "multi", opt.value));
      grid.appendChild(btn);
    });

    parentEl.appendChild(grid);

    // other text input if "other" selected
    if (otherKey && Array.isArray(fstate[key]) && fstate[key].includes("other")) {
      const lab = document.createElement("label");
      lab.textContent = "Other";
      parentEl.appendChild(lab);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Type other location…";
      input.value = fstate[otherKey] || "";
      input.addEventListener("input", (e) => {
        fstate[otherKey] = e.target.value;
        updateOutputs();
      });
      parentEl.appendChild(input);
    }
  }

  function renderFollowBlock(parentEl){
    const block = document.createElement("div");
    block.className = "block follow";
    block.innerHTML = `<h2>Follow Up Report</h2>`;

    // 360 (completed / not completed)
    const title = document.createElement("div");
    title.style.margin = "0 0 10px 0";
    title.innerHTML = `<b>Results of the 360</b>`;
    block.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";
    ["Completed","Not completed"].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = "r360";
      btn.dataset.fvalue = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        fstate.r360 = v;
        refreshSelectedUI();
        updateOutputs();
      });
      grid.appendChild(btn);
    });
    block.appendChild(grid);

    // Safety concerns: two buttons side-by-side
    renderTwoButtonSingle(block, "Immediate safety concerns", "safetyMode", "Safety concerns", "None noted");

    // If safety concerns selected, show free-text box
    if ((fstate.safetyMode || "") === "Safety concerns"){
      const lab = document.createElement("label");
      lab.textContent = "Safety concerns details";
      block.appendChild(lab);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., power lines down, propane, unstable wall…";
      input.value = fstate.safetyText || "";
      input.addEventListener("input", (e) => {
        fstate.safetyText = e.target.value;
        updateOutputs();
      });
      block.appendChild(input);
    }

    // Change IAP: two buttons side-by-side
    renderTwoButtonSingle(block, "Change IAP", "changeIap", "Yes", "No");

    // If Change IAP = Yes, show new IAP picker (mirrors size-up IAP)
    if ((fstate.changeIap || "") === "Yes"){
      const divider = document.createElement("div");
      divider.style.margin = "12px 0 0 0";
      divider.innerHTML = `<b>New Initial Action Plan</b>`;
      block.appendChild(divider);

      // tasks
      renderFollowMultiGroup(
        block,
        "Task (multi)",
        "newIapTasks",
        CONFIG.find(g => g.key==="iapTasks").options
      );

      // location
      renderFollowMultiGroup(
        block,
        "IAP Location (multi)",
        "newIapLocation",
        CONFIG.find(g => g.key==="iapLocation").options,
        "newIapLocationOther"
      );

      // objectives
      renderFollowMultiGroup(
        block,
        "Objective (multi)",
        "newIapObjectives",
        CONFIG.find(g => g.key==="iapObjectives").options
      );
    }

    // Confirm Strategy stays the same
    const cTitle = document.createElement("div");
    cTitle.style.margin = "12px 0 10px 0";
    cTitle.innerHTML = `<b>Confirm Strategy</b>`;
    block.appendChild(cTitle);

    const cGrid = document.createElement("div");
    cGrid.className = "grid";
    ["Offensive","Defensive"].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = "confirmStrategy";
      btn.dataset.fvalue = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        fstate.confirmStrategy = v;
        refreshSelectedUI();
        updateOutputs();
      });
      cGrid.appendChild(btn);
    });
    block.appendChild(cGrid);

    // Resource determination
    const rTitle = document.createElement("div");
    rTitle.style.margin = "12px 0 10px 0";
    rTitle.innerHTML = `<b>Resource determination</b>`;
    block.appendChild(rTitle);

    const rGrid = document.createElement("div");
    rGrid.className = "grid";
    ["Recall units","2nd alarm"].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = "resourceDetermination";
      btn.dataset.fvalue = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        fstate.resourceDetermination = v;
        refreshSelectedUI();
        updateOutputs();
      });
      rGrid.appendChild(btn);
    });
    block.appendChild(rGrid);

    parentEl.appendChild(block);
  }

  function renderControls(){
    controlsEl.innerHTML = "";

    renderDropdownBlock(controlsEl);

    // IRR
    const irr = document.createElement("div");
    irr.className = "irrWrap";
    irr.innerHTML = `<div class="irrTitle">IRR</div>`;
    const cols = document.createElement("div");
    cols.className = "twoCol";

    const building = document.createElement("div");
    building.className = "block building";
    building.innerHTML = `<h2>Building Description</h2>`;
    renderButtonGroup(CONFIG.find(g => g.key==="buildingSize"), building);
    renderButtonGroup(CONFIG.find(g => g.key==="height"), building);
    renderButtonGroup(CONFIG.find(g => g.key==="occupancy"), building);

    const problem = document.createElement("div");
    problem.className = "block problem";
    problem.innerHTML = `<h2>Problem Description</h2>`;
    renderButtonGroup(CONFIG.find(g => g.key==="conditions"), problem);
    renderButtonGroup(CONFIG.find(g => g.key==="problemSides"), problem);

    cols.appendChild(building);
    cols.appendChild(problem);
    irr.appendChild(cols);
    controlsEl.appendChild(irr);

    // IAP + Strategy/Command
    const row = document.createElement("div");
    row.className = "miniRow";

    const iap = document.createElement("div");
    iap.className = "block iap";
    iap.innerHTML = `<h2>Initial Action Plan</h2>`;
    renderButtonGroup(CONFIG.find(g => g.key==="iapTasks"), iap);
    renderButtonGroup(CONFIG.find(g => g.key==="iapLocation"), iap);
    renderButtonGroup(CONFIG.find(g => g.key==="iapObjectives"), iap);

    const cmd = document.createElement("div");
    cmd.className = "block cmd";
    cmd.innerHTML = `<h2>Strategy / Command</h2>`;

    const stratLabel = document.createElement("div");
    stratLabel.style.margin = "0 0 10px 0";
    stratLabel.innerHTML = `<b>Strategy</b>`;
    cmd.appendChild(stratLabel);

    const stratGrid = document.createElement("div");
    stratGrid.className = "grid";
    ["Offensive","Defensive"].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.key = "strategy";
      btn.dataset.value = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        state.strategy = v;
        refreshSelectedUI();
        updateOutputs();
      });
      stratGrid.appendChild(btn);
    });
    cmd.appendChild(stratGrid);

    const cmdLabel = document.createElement("div");
    cmdLabel.className = "boldLabel";
    cmdLabel.style.margin = "12px 0 10px 0";
    cmdLabel.textContent = "Command";
    cmd.appendChild(cmdLabel);

    const cmdInput = document.createElement("input");
    cmdInput.type = "text";
    cmdInput.placeholder = "e.g., Trk 1 is now Main Street Command";
    cmdInput.value = state.commandText || "";
    cmdInput.addEventListener("input", (e) => {
      state.commandText = e.target.value;
      updateOutputs();
    });
    cmd.appendChild(cmdInput);

    row.appendChild(iap);
    row.appendChild(cmd);
    controlsEl.appendChild(row);

    // Follow-up controls
    const followCard = document.getElementById("followControlsCard");
    if (followCard) {
      followCard.innerHTML = "";
      renderFollowBlock(followCard);
    }

    refreshSelectedUI();
  }

  function refreshSelectedUI(){
    document.querySelectorAll("button.choice").forEach(btn => {
      // size-up
      if (btn.dataset.key) {
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        if (key === "strategy") {
          btn.classList.toggle("selected", (state.strategy || "") === value);
          return;
        }
        const group = CONFIG.find(g => g.key === key);
        if (!group) return;
        const current = state[key];
        const selected = (group.mode === "single")
          ? current === value
          : Array.isArray(current) && current.includes(value);
        btn.classList.toggle("selected", selected);
      }

      // follow-up
      if (btn.dataset.fkey) {
        const k = btn.dataset.fkey;
        const v = btn.dataset.fvalue;

        // follow-up multi groups
        const current = fstate[k];
        const isMulti = Array.isArray(current);
        const selected = isMulti ? current.includes(v) : (current || "") === v;

        btn.classList.toggle("selected", selected);
      }
    });

    // problem quick buttons selection
    const q = Array.isArray(state.problemLocQuick) ? state.problemLocQuick : [];
    document.querySelectorAll(".grid.small button.choice.small").forEach(b => {
      b.classList.toggle("selected", q.includes(b.textContent));
    });
  }

  function updateOutputs(){
    // ---------- SIZE-UP ----------
    const battalionCode = (state.battalion || "").trim();
    const battalion = battalionDisplay(battalionCode);
    const apparatus = (state.apparatus || "").trim();

    const bSize = (state.buildingSize || "").trim();
    const bHeight = singlePhrase("height");

    let occ = "";
    if (state.occupancy === "other") occ = (state.occupancyOther || "").trim();
    else if (state.occupancy) occ = optionPhrase("occupancy", state.occupancy);

    const condition = singlePhrase("conditions");

    const sides = multiList("problemSides");
    const sidesText = sides.length ? niceSidesDisplay(sides) : "";

    const quick = Array.isArray(state.problemLocQuick) ? state.problemLocQuick : [];
    const quickText = quick.length ? quick.map(x => x.toLowerCase()).join(", ") : "";

    const locFree = (state.problemLocationText || "").trim();
    const locCombined = [quickText, locFree].filter(Boolean).join(", ").trim();

    const tasks = multiList("iapTasks").map(v => optionPhrase("iapTasks", v)).filter(Boolean);

    const iapLocPhrase = buildIapLocationPhrase(state.iapLocation, state.iapLocationOther);

    const objectives = multiList("iapObjectives").map(v => optionPhrase("iapObjectives", v)).filter(Boolean);

    const strategy = (state.strategy || "Offensive").toLowerCase();
    const cmdText = normalizeCommandName(state.commandText);

    const buildingParts = [bSize, bHeight, occ].filter(Boolean);
    const buildingPhrase = buildingParts.length ? buildingParts.join(" ") : "a structure";

    let probPhrase = "";
    if (sidesText && !locCombined) {
      probPhrase = `${sidesText} side`;
    } else {
      probPhrase = [sidesText ? `${sidesText} side` : "", locCombined].filter(Boolean).join(" ").trim();
    }

    const taskPhrase = tasks.length ? tasks.join(", ") : "";
    const objPhrase = objectives.length ? objectives.join(", ") : "";

    const line1 =
      `${battalion ? battalion + " " : ""}` +
      `${apparatus ? "From " + apparatus + ", " : ""}` +
      `We are on scene with a ${buildingPhrase}` +
      `${condition ? ", with " + condition : ""}` +
      `${probPhrase ? " on the " + probPhrase : ""}.`;

    const line2 =
      `${apparatus ? apparatus + " " : ""}` +
      `${taskPhrase ? "will be " + taskPhrase : "will be operating"}` +
      `${iapLocPhrase ? " on the " + iapLocPhrase : ""}` +
      `${objPhrase ? " for " + objPhrase : ""}.`;

    const line3 =
      `We will be in the ${strategy} strategy` +
      `${cmdText ? ", we are " + cmdText : ""}.`;

    outputBox.textContent = [line1, line2, line3].join("\n\n");

    // ---------- FOLLOW-UP ----------
    const fBattalion = battalionDisplay(state.battalion);
    const fCommand = normalizeCommandName(state.commandText);

    const r360 = (fstate.r360 || "").trim();
    const safetyMode = (fstate.safetyMode || "").trim();
    const safetyText = (fstate.safetyText || "").trim();
    const changeIap = (fstate.changeIap || "").trim();
    const confirmStrat = ((fstate.confirmStrategy || state.strategy || "Offensive") + "").trim().toLowerCase();
    const resource = (fstate.resourceDetermination || "").trim();

    // build new IAP phrase (if change IAP = Yes)
    let newIapLine = "";
    if (changeIap === "Yes") {
      const ntasks = (Array.isArray(fstate.newIapTasks) ? fstate.newIapTasks : [])
        .map(v => optionPhrase("iapTasks", v)).filter(Boolean);

      const nloc = buildIapLocationPhrase(fstate.newIapLocation, fstate.newIapLocationOther);

      const nobj = (Array.isArray(fstate.newIapObjectives) ? fstate.newIapObjectives : [])
        .map(v => optionPhrase("iapObjectives", v)).filter(Boolean);

      const t = ntasks.length ? ntasks.join(", ") : "operating";
      const o = nobj.length ? ` for ${nobj.join(", ")}` : "";
      const l = nloc ? ` on the ${nloc}` : "";

      // "read just like the IAP from generate size up"
      // "read just like the IAP from generate size up"
newIapLine = `There is a change to the IAP, ${state.apparatus ? state.apparatus + " " : ""}will be ${t}${l}${o}.`;
    }

    const parts = [];

    // lead-in
    const lead =
      `${fBattalion ? fBattalion + " " : ""}` +
      `${fCommand ? "From " + fCommand + ", " : ""}` +
      `${r360 ? "360 was " + r360 : ""}`.trim();

    if (lead) parts.push(lead + (lead.endsWith(".") ? "" : ","));

    // safety sentence
    if (safetyMode === "None noted") {
      parts.push("no safety concerns,");
    } else if (safetyMode === "Safety concerns") {
      parts.push(`${safetyText ? safetyText : "Safety concerns noted"},`);
    }

    // change IAP sentence (only if Yes)
    if (newIapLine) parts.push(newIapLine.endsWith(".") ? newIapLine : (newIapLine + "."));

    // remaining strategy
    parts.push(`We are remaining in the ${confirmStrat} strategy.`);

    // resource
    if (resource === "Recall units") parts.push("Recall units.");
    if (resource === "2nd alarm") parts.push("Give me a 2nd alarm.");

    // cleanup: if nothing selected, show helper text
    const cleaned = parts.join(" ").replace(/\s+/g," ").trim();
    followOutputBox.textContent = cleaned || "Follow-up report: (make selections above).";
  }

  function init(){
    renderControls();
    updateOutputs();
  }

  init();
</script>
</body>
</html>
