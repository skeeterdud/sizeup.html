<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFD Size-Up Builder</title>

  <!-- iPhone / PWA settings -->
  <meta name="theme-color" content="#0b1a3a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --navy:#0b1a3a;
      --blue:#2563eb;
      --text:#0b1220;
      --muted: rgba(11,18,32,.75);

      --sec1:#fde68a;  /* Your Apparatus */
      --sec2:#e0e7ff;  /* IRR wrapper */
      --sec3:#cffafe;  /* Follow Up wrapper */

      --cardBg: rgba(18,26,43,.75);
      --cardBorder: rgba(255,255,255,.10);

      --wmOpacity: 0.10;
      --wmSize: 820px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #172554 0%, var(--navy) 55%) fixed;
      color:#e9eefc;
    }

    /* watermark */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("logo.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: var(--wmSize);
      opacity: var(--wmOpacity);
      pointer-events: none;
      z-index: 0;
    }

    header{
      padding:14px 16px;
      background: rgba(17,31,66,.90);
      position: sticky;
      top:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      z-index: 2;
    }
    h1{margin:0;font-size:16px}
    .hint{color:rgba(233,238,252,.75);font-size:12px;margin-top:4px}

    .wrap{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      padding:12px;
      position:relative;
      z-index:1;
    }

    .card{
      background: var(--cardBg);
      border: 1px solid var(--cardBorder);
      border-radius:16px;
      padding:12px;
    }

    /* Big sections */
    .section{
      border-radius:18px;
      padding:12px;
      border:1px solid rgba(0,0,0,.12);
      color: var(--text);
    }
    .sectionTitle{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.5px;
      text-transform:uppercase;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .sec1{ background: var(--sec1); }
    .sec2{ background: var(--sec2); }
    .sec3{ background: var(--sec3); }

    /* Layout helpers */
    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .twoCol{grid-template-columns:1fr;}
    }

    /* Dropdowns (Batt + Apparatus) */
    .selectRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 800px){
      .selectRow{grid-template-columns:1fr;}
    }

    /* Group headings */
    .groupHead{
      margin: 0 0 10px 0;
      font-weight: 900;
      color: var(--text);
      font-size: 14px;
    }

    label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin:10px 0 6px;
    }

    select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color:var(--text);
      font-size:15px;
      font-weight:800;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#ffffff;
      color:var(--text);
      font-size:15px;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* Buttons (4 across) */
    .grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    button.choice{
      border:1px solid rgba(0,0,0,.10);
      background:#ffffff;
      color:var(--text);
      padding:12px 10px;
      border-radius:12px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    button.choice.selected{
      border-color:var(--blue);
      background:var(--blue);
      color:#ffffff;
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }

    /* Output boxes */
    .outputTitle{margin:0 0 10px 0;}
    .outputTitle b{color:#e9eefc;font-size:14px}

    .output{
      white-space:pre-wrap;
      font-size:16px;
      line-height:1.35;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      min-height:160px;
      color:#e9eefc;
    }

    .row3{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 650px){
      .row3{grid-template-columns:1fr;}
    }

    .row2{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 650px){
      .row2{grid-template-columns:1fr;}
    }

    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#e9eefc;
      padding:12px 12px;
      border-radius:14px;
      font-size:15px;
      font-weight:1000;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.10);
    }
    .btn.danger{
      border-color: rgba(193,18,31,.55);
      background: rgba(193,18,31,.18);
    }

    /* Edit Mode UI */
    .editBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 10px 0;
    }
    .editChip{
      border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.7);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-weight:1000;
      cursor:pointer;
    }
  </style>
</head>

<body>
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <div>
      <h1 style="margin:0;">MFD Size-Up Builder</h1>
      <div class="hint">Tap selections → paragraphs update → Copy.</div>
    </div>
    <button class="btn primary" id="editBtn" style="min-width:110px;">Edit</button>
  </div>
</header>

<div class="wrap">

  <!-- SECTION 1: Your Apparatus -->
  <div class="card">
    <div class="section sec1" id="section1"></div>
  </div>

  <!-- SECTION 2: IRR (includes generated size-up) -->
  <div class="card">
    <div class="section sec2" id="section2"></div>
  </div>

  <!-- SECTION 3: Follow Up Report (includes generated follow-up) -->
  <div class="card">
    <div class="section sec3" id="section3"></div>
  </div>

</div>

<script>
  // Offline cache
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("service-worker.js"));
  }

  // ===== Edit Mode (PIN protected) =====
  const EDIT_PIN = "535"; // change if you want
  let editMode = false;

  function updateEditButton(){
    const btn = document.getElementById("editBtn");
    if (!btn) return;
    btn.textContent = editMode ? "Done" : "Edit";
  }

  function requestEditModeToggle(){
    if (editMode) {
      editMode = false;
      updateEditButton();
      renderAll();
      return;
    }
    const entered = prompt("Enter Edit PIN:");
    if (entered === null) return;
    if (entered.trim() === EDIT_PIN) {
      editMode = true;
      updateEditButton();
      renderAll();
    } else {
      alert("Incorrect PIN.");
    }
  }

  // ===== Config persistence (device/browser) =====
  const CONFIG_STORAGE_KEY = "mfd_sizeup_config_v2";
  const FOLLOW_STORAGE_KEY = "mfd_follow_config_v2";

  // ---------- IRR Groups (buttons) ----------
  const CONFIG = [
    { key:"buildingSize", title:"Building Size", mode:"single", options:[
      { value:"Small",  label:"Small",  phrase:"Small" },
      { value:"Medium", label:"Medium", phrase:"Medium" },
      { value:"Large",  label:"Large",  phrase:"Large" },
      { value:"Mega",   label:"Mega",   phrase:"Mega" }
    ]},
    { key:"height", title:"Building Height", mode:"single", options:[
      { value:"1", label:"1", phrase:"1 story" },
      { value:"2", label:"2", phrase:"2 story" },
      { value:"3", label:"3", phrase:"3 story" },
      { value:"4", label:"4", phrase:"4 story" },
      { value:"5", label:"5", phrase:"5 story" }
    ]},
    { key:"occupancy", title:"Occupancy Type", mode:"single", options:[
      { value:"house", label:"House", phrase:"house" },
      { value:"apartment", label:"Apartment", phrase:"apartment" },
      { value:"strip", label:"Strip Center", phrase:"strip center" },
      { value:"commercial", label:"Commercial", phrase:"commercial" },
      { value:"other", label:"Other", phrase:"" }
    ]},
    { key:"conditions", title:"Condition", mode:"single", options:[
      { value:"nothing", label:"Nothing Showing", phrase:"nothing showing" },
      { value:"light", label:"Light Smoke", phrase:"light smoke" },
      { value:"heavy", label:"Heavy Smoke", phrase:"heavy smoke" },
      { value:"working", label:"Working Fire", phrase:"working fire" },
      { value:"defensive", label:"Defensive Conditions", phrase:"defensive conditions" }
    ]},
    { key:"problemSides", title:"Location of the Problem (multi)", mode:"multi", options:[
      { value:"Alpha", label:"Alpha", phrase:"alpha" },
      { value:"Bravo", label:"Bravo", phrase:"bravo" },
      { value:"Charlie", label:"Charlie", phrase:"charlie" },
      { value:"Delta", label:"Delta", phrase:"delta" }
    ]},
    { key:"iapTasks", title:"Task (multi)", mode:"multi", options:[
      { value:"Investigate", label:"Investigate", phrase:"investigating" },
      { value:"Water Supply", label:"Water Supply", phrase:"setting up water supply" },
      { value:"Attack Line", label:"Attack Line", phrase:"attack line" },
      { value:"Rescue", label:"Rescue", phrase:"rescue" },
      { value:"OEO", label:"OEO", phrase:"OEO" },
      { value:"Defensive Op", label:"Defensive Op", phrase:"defensive operations" }
    ]},
    { key:"iapLocation", title:"IAP Location", mode:"single", options:[
      { value:"Alpha", label:"Alpha", phrase:"alpha" },
      { value:"Bravo", label:"Bravo", phrase:"bravo" },
      { value:"Charlie", label:"Charlie", phrase:"charlie" },
      { value:"Delta", label:"Delta", phrase:"delta" }
    ]},
    { key:"iapObjectives", title:"Objective (multi)", mode:"multi", options:[
      { value:"Fire Attack", label:"Fire Attack", phrase:"fire attack" },
      { value:"Primary Search", label:"Primary Search", phrase:"primary search" }
    ]}
  ];

  // Section 1 dropdown data (Your Apparatus)
  const BATTALIONS = ["", "BC1", "BC2"];
  const APPARATUS = ["",
    "Trk 1","Eng 2","Trk 3","Eng 4","Trk 5","Eng 6","Eng 7","Trk 9","Eng 10","Trk 11",
    "Med 1","Med 2","Med 3","Med 5","Med 6","Med 7","Med 9","Med 10","Med 11"
  ];

  // ---------- Follow-up groups ----------
  const FOLLOW = [
    { key:"r360", title:"Results of the 360", mode:"single", options:[
      { value:"Completed", label:"Completed", phrase:"Completed" },
      { value:"Not completed", label:"Not completed", phrase:"Not completed" }
    ]},
    { key:"confirmStrategy", title:"Confirm Strategy/Change IAP", mode:"single", options:[
      { value:"Offensive", label:"Offensive", phrase:"Offensive" },
      { value:"Defensive", label:"Defensive", phrase:"Defensive" }
    ]},
    { key:"resourceDetermination", title:"Resource Determination", mode:"single", options:[
      { value:"Recall units", label:"Recall units", phrase:"Recall units" },
      { value:"2nd alarm", label:"2nd alarm", phrase:"2nd alarm" }
    ]}
  ];

  function saveConfig(){
    try { localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(CONFIG)); } catch(e) {}
    try { localStorage.setItem(FOLLOW_STORAGE_KEY, JSON.stringify(FOLLOW)); } catch(e) {}
  }

  function loadConfig(){
    try{
      const raw = localStorage.getItem(CONFIG_STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          CONFIG.length = 0;
          parsed.forEach(x => CONFIG.push(x));
        }
      }
    }catch(e){}

    try{
      const raw2 = localStorage.getItem(FOLLOW_STORAGE_KEY);
      if (raw2) {
        const parsed2 = JSON.parse(raw2);
        if (Array.isArray(parsed2)) {
          FOLLOW.length = 0;
          parsed2.forEach(x => FOLLOW.push(x));
        }
      }
    }catch(e){}
  }

  // ---------- State ----------
  const state = {};
  const fstate = {};

  // Outputs references (created during render)
  let outputBox = null;
  let followOutputBox = null;

  function init(){
    loadConfig();
    document.getElementById("editBtn").addEventListener("click", requestEditModeToggle);
    updateEditButton();
    renderAll();
  }

  // ---------- Interaction ----------
  function onChoice(group, value){
    if (group.mode === "single") state[group.key] = value;
    else {
      const current = Array.isArray(state[group.key]) ? state[group.key] : [];
      state[group.key] = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
    }
    renderAll(false); // re-render to update selected UI
    updateOutputs();
  }

  function onFollowChoice(group, value){
    fstate[group.key] = value;
    renderAll(false);
    updateOutputs();
  }

  // ---------- Render helpers ----------
  function renderButtonGroup(group, parentEl){
    if (!group) return;

    if (editMode) {
      const bar = document.createElement("div");
      bar.className = "editBar";

      const add = document.createElement("button");
      add.className = "editChip";
      add.textContent = "➕ Add Button";
      add.addEventListener("click", () => {
        const label = prompt(`Add a new button to: ${group.title}\nButton label:`);
        if (!label) return;
        const phrase = prompt("Optional phrase for the paragraph (leave blank to use label):") || "";
        const value = label.trim();
        group.options.push({ value, label: label.trim(), phrase: (phrase.trim() || label.trim()) });
        saveConfig();
        renderAll();
      });

      bar.appendChild(add);
      parentEl.appendChild(bar);
    }

    const title = document.createElement("div");
    title.className = "groupHead";
    title.textContent = group.title;
    parentEl.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.key = group.key;
      btn.dataset.value = opt.value;
      btn.textContent = opt.label;
      btn.addEventListener("click", () => onChoice(group, opt.value));
      grid.appendChild(btn);
    });

    parentEl.appendChild(grid);

    // Occupancy Other input directly under occupancy
    if (group.key === "occupancy" && state.occupancy === "other") {
      const label = document.createElement("label");
      label.textContent = "Occupancy Type";
      parentEl.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., school, church, warehouse…";
      input.value = state.occupancyOther || "";
      input.addEventListener("input", (e) => {
        state.occupancyOther = e.target.value;
        updateOutputs();
      });
      parentEl.appendChild(input);
    }

    // Problem location free-text directly under sides
    if (group.key === "problemSides") {
      const label = document.createElement("label");
      label.textContent = "Location of the Problem";
      parentEl.appendChild(label);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "e.g., 2nd floor / roof line / rear storage…";
      input.value = state.problemLocationText || "";
      input.addEventListener("input", (e) => {
        state.problemLocationText = e.target.value;
        updateOutputs();
      });
      parentEl.appendChild(input);
    }
  }

  function renderFollowGroup(group, parentEl){
    if (!group) return;

    if (editMode) {
      const bar = document.createElement("div");
      bar.className = "editBar";

      const add = document.createElement("button");
      add.className = "editChip";
      add.textContent = "➕ Add Button";
      add.addEventListener("click", () => {
        const label = prompt(`Add a new button to: ${group.title}\nButton label:`);
        if (!label) return;
        const phrase = prompt("Optional phrase (leave blank to use label):") || "";
        const value = label.trim();
        group.options.push({ value, label: label.trim(), phrase: (phrase.trim() || label.trim()) });
        saveConfig();
        renderAll();
      });

      bar.appendChild(add);
      parentEl.appendChild(bar);
    }

    const title = document.createElement("div");
    title.className = "groupHead";
    title.textContent = group.title;
    parentEl.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid";

    group.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.fkey = group.key;
      btn.dataset.fvalue = opt.value;
      btn.textContent = opt.label;
      btn.addEventListener("click", () => onFollowChoice(group, opt.value));
      grid.appendChild(btn);
    });

    parentEl.appendChild(grid);
  }

  function renderDropdowns(parentEl){
    const row = document.createElement("div");
    row.className = "selectRow";

    const battWrap = document.createElement("div");
    const battLabel = document.createElement("label");
    battLabel.textContent = "Battalion";
    battWrap.appendChild(battLabel);

    const battSel = document.createElement("select");
    BATTALIONS.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v || "Select Battalion…";
      battSel.appendChild(opt);
    });
    battSel.value = state.battalion || "";
    battSel.addEventListener("change", (e) => {
      state.battalion = e.target.value;
      updateOutputs();
    });
    battWrap.appendChild(battSel);

    const appWrap = document.createElement("div");
    const appLabel = document.createElement("label");
    appLabel.textContent = "Apparatus";
    appWrap.appendChild(appLabel);

    const appSel = document.createElement("select");
    APPARATUS.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v || "Select Apparatus…";
      appSel.appendChild(opt);
    });
    appSel.value = state.apparatus || "";
    appSel.addEventListener("change", (e) => {
      state.apparatus = e.target.value;
      updateOutputs();
    });
    appWrap.appendChild(appSel);

    row.appendChild(battWrap);
    row.appendChild(appWrap);
    parentEl.appendChild(row);
  }

  function refreshSelectedUI(){
    document.querySelectorAll("button.choice").forEach(btn => {
      // IRR buttons
      if (btn.dataset.key) {
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        if (key === "strategy") {
          btn.classList.toggle("selected", (state.strategy || "") === value);
          return;
        }
        const group = CONFIG.find(g => g.key === key);
        if (!group) return;
        const current = state[key];
        const selected = (group.mode === "single")
          ? current === value
          : Array.isArray(current) && current.includes(value);
        btn.classList.toggle("selected", selected);
      }
      // follow-up buttons
      if (btn.dataset.fkey) {
        const k = btn.dataset.fkey;
        const v = btn.dataset.fvalue;
        btn.classList.toggle("selected", (fstate[k] || "") === v);
      }
    });
  }

  // ---------- Build Sections ----------
  function renderSection1(){
    const s1 = document.getElementById("section1");
    s1.innerHTML = "";

    const title = document.createElement("div");
    title.className = "sectionTitle";
    title.textContent = "Section 1 — Your Apparatus";
    s1.appendChild(title);

    renderDropdowns(s1);
  }

  function renderSection2(){
    const s2 = document.getElementById("section2");
    s2.innerHTML = "";

    const title = document.createElement("div");
    title.className = "sectionTitle";
    title.textContent = "Section 2 — IRR";
    s2.appendChild(title);

    // Top row: Building Size (left) / Condition (right)
    const top = document.createElement("div");
    top.className = "twoCol";

    const left = document.createElement("div");
    left.style.background = "rgba(255,255,255,.55)";
    left.style.border = "1px solid rgba(0,0,0,.10)";
    left.style.borderRadius = "16px";
    left.style.padding = "12px";

    renderButtonGroup(CONFIG.find(g => g.key==="buildingSize"), left);
    renderButtonGroup(CONFIG.find(g => g.key==="height"), left);
    renderButtonGroup(CONFIG.find(g => g.key==="occupancy"), left);

    const right = document.createElement("div");
    right.style.background = "rgba(255,255,255,.55)";
    right.style.border = "1px solid rgba(0,0,0,.10)";
    right.style.borderRadius = "16px";
    right.style.padding = "12px";

    renderButtonGroup(CONFIG.find(g => g.key==="conditions"), right);
    renderButtonGroup(CONFIG.find(g => g.key==="problemSides"), right);

    top.appendChild(left);
    top.appendChild(right);
    s2.appendChild(top);

    // Second row: IAP (left) / Strategy/Command (right)
    const mid = document.createElement("div");
    mid.className = "twoCol";
    mid.style.marginTop = "12px";

    const iapBox = document.createElement("div");
    iapBox.style.background = "rgba(255,255,255,.55)";
    iapBox.style.border = "1px solid rgba(0,0,0,.10)";
    iapBox.style.borderRadius = "16px";
    iapBox.style.padding = "12px";

    const iapTitle = document.createElement("div");
    iapTitle.className = "sectionTitle";
    iapTitle.style.fontSize = "13px";
    iapTitle.style.textTransform = "uppercase";
    iapTitle.style.letterSpacing = ".5px";
    iapTitle.style.marginBottom = "8px";
    iapTitle.textContent = "Initial Action Plan";
    iapBox.appendChild(iapTitle);

    renderButtonGroup(CONFIG.find(g => g.key==="iapTasks"), iapBox);
    renderButtonGroup(CONFIG.find(g => g.key==="iapLocation"), iapBox);
    renderButtonGroup(CONFIG.find(g => g.key==="iapObjectives"), iapBox);

    const stratCmdBox = document.createElement("div");
    stratCmdBox.style.background = "rgba(255,255,255,.55)";
    stratCmdBox.style.border = "1px solid rgba(0,0,0,.10)";
    stratCmdBox.style.borderRadius = "16px";
    stratCmdBox.style.padding = "12px";

    const scTitle = document.createElement("div");
    scTitle.className = "sectionTitle";
    scTitle.style.fontSize = "13px";
    scTitle.style.textTransform = "uppercase";
    scTitle.style.letterSpacing = ".5px";
    scTitle.style.marginBottom = "8px";
    scTitle.textContent = "Strategy / Command";
    stratCmdBox.appendChild(scTitle);

    // Strategy buttons
    const stratHead = document.createElement("div");
    stratHead.className = "groupHead";
    stratHead.textContent = "Strategy";
    stratCmdBox.appendChild(stratHead);

    const stratGrid = document.createElement("div");
    stratGrid.className = "grid";
    ["Offensive","Defensive"].forEach(v => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.dataset.key = "strategy";
      btn.dataset.value = v;
      btn.textContent = v;
      btn.addEventListener("click", () => {
        state.strategy = v;
        renderAll(false);
        updateOutputs();
      });
      stratGrid.appendChild(btn);
    });
    stratCmdBox.appendChild(stratGrid);

    // Command (styled like Strategy)
    const cmdHead = document.createElement("div");
    cmdHead.className = "groupHead";
    cmdHead.textContent = "Command";
    stratCmdBox.appendChild(cmdHead);

    const cmdInput = document.createElement("input");
    cmdInput.type = "text";
    cmdInput.placeholder = "e.g., Main Street";
    cmdInput.value = state.commandText || "";
    cmdInput.addEventListener("input", (e) => {
      state.commandText = e.target.value;
      updateOutputs();
    });
    stratCmdBox.appendChild(cmdInput);

    mid.appendChild(iapBox);
    mid.appendChild(stratCmdBox);
    s2.appendChild(mid);

    // Generated Size Up output (inside Section 2)
    const outWrap = document.createElement("div");
    outWrap.style.marginTop = "12px";
    outWrap.innerHTML = `
      <div class="outputTitle"><b>Generated Size-Up</b></div>
      <div class="output" id="outputBox">Make selections to build your size-up.</div>
      <div class="row3">
        <button class="btn primary" id="copyBtn">Copy Size-Up</button>
        <button class="btn primary" id="printBtn">Print / PDF</button>
        <button class="btn danger" id="clearSizeupBtn">Clear Size-Up</button>
      </div>
    `;
    s2.appendChild(outWrap);
  }

  function renderSection3(){
    const s3 = document.getElementById("section3");
    s3.innerHTML = "";

    const title = document.createElement("div");
    title.className = "sectionTitle";
    title.textContent = "Section 3 — Follow Up Report";
    s3.appendChild(title);

    // Follow-up controls
    const followBox = document.createElement("div");
    followBox.style.background = "rgba(255,255,255,.55)";
    followBox.style.border = "1px solid rgba(0,0,0,.10)";
    followBox.style.borderRadius = "16px";
    followBox.style.padding = "12px";

    const fTitle = document.createElement("div");
    fTitle.className = "sectionTitle";
    fTitle.style.fontSize = "13px";
    fTitle.style.textTransform = "uppercase";
    fTitle.style.letterSpacing = ".5px";
    fTitle.style.marginBottom = "8px";
    fTitle.textContent = "Follow Up Report";
    followBox.appendChild(fTitle);

    renderFollowGroup(FOLLOW.find(g => g.key==="r360"), followBox);

    const addLabel = document.createElement("label");
    addLabel.textContent = "Additional information";
    followBox.appendChild(addLabel);

    const addInput = document.createElement("input");
    addInput.type = "text";
    addInput.placeholder = "Optional notes…";
    addInput.value = fstate.additional || "";
    addInput.addEventListener("input", (e) => {
      fstate.additional = e.target.value;
      updateOutputs();
    });
    followBox.appendChild(addInput);

    const safTitle = document.createElement("div");
    safTitle.className = "groupHead";
    safTitle.textContent = "Immediate safety concerns";
    followBox.appendChild(safTitle);

    const safInput = document.createElement("input");
    safInput.type = "text";
    safInput.placeholder = "e.g., power lines down, propane, unstable wall…";
    safInput.value = fstate.safety || "";
    safInput.addEventListener("input", (e) => {
      fstate.safety = e.target.value;
      updateOutputs();
    });
    followBox.appendChild(safInput);

    renderFollowGroup(FOLLOW.find(g => g.key==="confirmStrategy"), followBox);

    const notesLabel = document.createElement("label");
    notesLabel.textContent = "Notes";
    followBox.appendChild(notesLabel);

    const notesInput = document.createElement("input");
    notesInput.type = "text";
    notesInput.placeholder = "Optional notes…";
    notesInput.value = fstate.confirmNotes || "";
    notesInput.addEventListener("input", (e) => {
      fstate.confirmNotes = e.target.value;
      updateOutputs();
    });
    followBox.appendChild(notesInput);

    renderFollowGroup(FOLLOW.find(g => g.key==="resourceDetermination"), followBox);

    s3.appendChild(followBox);

    // Generated Follow-up output (inside Section 3)
    const outWrap = document.createElement("div");
    outWrap.style.marginTop = "12px";
    outWrap.innerHTML = `
      <div class="outputTitle"><b>Generated Follow-Up Report</b></div>
      <div class="output" id="followOutputBox">Make selections to build your follow-up report.</div>
      <div class="row2">
        <button class="btn primary" id="copyFollowBtn">Copy Follow-Up</button>
        <button class="btn danger" id="clearFollowBtn">Clear Follow-Up</button>
      </div>
    `;
    s3.appendChild(outWrap);
  }

  function wireButtons(){
    outputBox = document.getElementById("outputBox");
    followOutputBox = document.getElementById("followOutputBox");

    const copyBtn = document.getElementById("copyBtn");
    const clearSize = document.getElementById("clearSizeupBtn");
    const printBtn = document.getElementById("printBtn");

    if (copyBtn) copyBtn.addEventListener("click", () => copyFrom(outputBox, "Copied size-up!"));
    if (clearSize) clearSize.addEventListener("click", clearSizeup);
    if (printBtn) printBtn.addEventListener("click", printPDF);

    const copyFollow = document.getElementById("copyFollowBtn");
    const clearFollowBtn = document.getElementById("clearFollowBtn");
    if (copyFollow) copyFollow.addEventListener("click", () => copyFrom(followOutputBox, "Copied follow-up!"));
    if (clearFollowBtn) clearFollowBtn.addEventListener("click", clearFollow);
  }

  // Render all sections. If full=true, also rewires buttons.
  function renderAll(full=true){
    renderSection1();
    renderSection2();
    renderSection3();
    refreshSelectedUI();
    wireButtons();
    updateOutputs();
  }

  // ---------- Text building ----------
  function optionPhrase(groupKey, value){
    const group = CONFIG.find(g => g.key === groupKey);
    if (!group) return "";
    return (group.options.find(o => o.value === value)?.phrase || "").trim();
  }
  function singlePhrase(key){
    const val = state[key];
    if (!val) return "";
    return optionPhrase(key, val);
  }
  function multiList(key){
    const arr = Array.isArray(state[key]) ? state[key] : [];
    return arr.filter(Boolean);
  }
  function niceSidesDisplay(sidesArr){
    return sidesArr.map(s => s.toLowerCase()).join(" ");
  }

  function normalizeCommandName(raw){
    let s = (raw || "").trim();
    if (!s) return "";
    if (/command\.?$/i.test(s)) return s.replace(/\.*$/,"");
    return `${s} Command`;
  }

  function updateOutputs(){
    if (!outputBox || !followOutputBox) return;

    // SIZE-UP
    const battalion = (state.battalion || "").trim();
    const apparatus = (state.apparatus || "").trim();

    const bSize = (state.buildingSize || "").trim();
    const bHeight = singlePhrase("height");
    let occ = "";
    if (state.occupancy === "other") occ = (state.occupancyOther || "").trim();
    else if (state.occupancy) occ = optionPhrase("occupancy", state.occupancy);

    const condition = singlePhrase("conditions");
    const sides = multiList("problemSides");
    const sidesText = sides.length ? niceSidesDisplay(sides) : "";
    const locFree = (state.problemLocationText || "").trim();

    const tasks = multiList("iapTasks").map(v => optionPhrase("iapTasks", v)).filter(Boolean);
    const iapLoc = singlePhrase("iapLocation");
    const objectives = multiList("iapObjectives").map(v => optionPhrase("iapObjectives", v)).filter(Boolean);

    const strategy = (state.strategy || "Offensive").toLowerCase();
    const cmdText = normalizeCommandName(state.commandText);

    const buildingParts = [bSize, bHeight, occ].filter(Boolean);
    const buildingPhrase = buildingParts.length ? buildingParts.join(" ") : "a structure";

    const probParts = [sidesText, locFree].filter(Boolean);
    const probPhrase = probParts.join(" ").trim();

    const taskPhrase = tasks.length ? tasks.join(", ") : "";
    const objPhrase = objectives.length ? objectives.join(", ") : "";

    const line1 =
      `${battalion ? battalion + " " : ""}` +
      `${apparatus ? "From " + apparatus + ", " : ""}` +
      `We are on scene with a ${buildingPhrase}` +
      `${condition ? ", with " + condition : ""}` +
      `${probPhrase ? " on the " + probPhrase : ""}.`;

    const line2 =
      `${apparatus ? apparatus + " " : ""}` +
      `${taskPhrase ? "will be " + taskPhrase : "will be operating"}` +
      `${iapLoc ? " on the " + iapLoc + " side" : ""}` +
      `${objPhrase ? " for " + objPhrase : ""}.`;

    const line3 =
      `We will be in the ${strategy} strategy` +
      `${cmdText ? ", we are " + cmdText : ""}.`;

    outputBox.textContent = [line1, line2, line3].join("\n\n");

    // FOLLOW-UP
    const r360 = (fstate.r360 || "").trim();
    const additional = (fstate.additional || "").trim();
    const safety = (fstate.safety || "").trim();
    const confirmStrat = (fstate.confirmStrategy || "").trim();
    const confirmNotes = (fstate.confirmNotes || "").trim();
    const resource = (fstate.resourceDetermination || "").trim();

    const lines = [];
    if (r360) lines.push(`Results of the 360: ${r360}.`);
    if (additional) lines.push(`Additional information: ${additional}${additional.endsWith(".") ? "" : "."}`);
    if (safety) lines.push(`Immediate safety concerns: ${safety}${safety.endsWith(".") ? "" : "."}`);
    if (confirmStrat) lines.push(`Confirm Strategy/Change IAP: ${confirmStrat}${confirmNotes ? " — " + confirmNotes : ""}.`);
    if (resource) lines.push(`Resource determination: ${resource}.`);

    if (!lines.length) lines.push("Follow-up report: (make selections above).");
    followOutputBox.textContent = lines.join("\n");
  }

  // ---------- Buttons ----------
  async function copyFrom(el, msg){
    const text = el?.textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      alert(msg);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert(msg);
    }
  }

  function clearSizeup(){
    Object.keys(state).forEach(k => delete state[k]);
    renderAll();
  }

  function clearFollow(){
    Object.keys(fstate).forEach(k => delete fstate[k]);
    renderAll();
  }

  // Print/PDF of just the generated paragraphs
  function escapeHtml(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function printPDF(){
    const sizeup = outputBox?.textContent || "";
    const follow = followOutputBox?.textContent || "";

    const w = window.open("", "_blank");
    if (!w) {
      alert("Pop-up blocked. Please allow pop-ups to print.");
      return;
    }

    const stamp = new Date().toLocaleString();

    w.document.open();
    w.document.write(`
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Size-Up Report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:28px;color:#111}
    h1{font-size:18px;margin:0 0 6px}
    .stamp{font-size:12px;color:#555;margin-bottom:18px}
    h2{font-size:14px;margin:18px 0 8px}
    .box{border:1px solid #ddd;border-radius:10px;padding:12px;white-space:pre-wrap;line-height:1.35}
    .footer{margin-top:18px;font-size:11px;color:#666}
    @media print { body{margin:18mm} }
  </style>
</head>
<body>
  <h1>MFD Size-Up Builder</h1>
  <div class="stamp">${escapeHtml(stamp)}</div>

  <h2>Generated Size-Up</h2>
  <div class="box">${escapeHtml(sizeup)}</div>

  <h2>Generated Follow-Up Report</h2>
  <div class="box">${escapeHtml(follow)}</div>

  <div class="footer">Generated from the MFD Size-Up Builder</div>

  <script>window.onload=()=>window.print();</script>
</body>
</html>
    `);
    w.document.close();
  }

  init();
</script>
</body>
</html>
